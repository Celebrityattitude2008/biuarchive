<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Profile | The BIU Archive</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"></script>
        <link rel="stylesheet" href="theme.css">
        <script>(function(){try{var t=localStorage.getItem('site-theme')||'dark';document.documentElement.classList.add('theme-'+t);}catch(e){}})();</script>
    <style>
        :root {
            --primary: #002147; --accent: #FFD700; --bg: #f8f9fa;
            --white: #ffffff; --text: #333; --success: #28a745; 
            --blue-tick: #00BFFF; --radius: 20px;
            --shadow: 0 10px 30px rgba(0,0,0,0.08);
        }

        [data-theme="dark"] { --primary: #FFD700; --accent: #002147; --bg: #121212; --white: #1e1e1e; --text: #f4f4f4; }

        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            background-color: var(--bg); color: var(--text); 
            margin: 0; padding: 15px; transition: 0.3s; 
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; box-sizing: border-box;
        }
        
        #loader-overlay {
            position: fixed; inset: 0; background: var(--bg); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }

        .profile-container { 
            width: 100%; max-width: 450px; background: var(--white); 
            padding: 30px 20px; border-radius: var(--radius); 
            box-shadow: var(--shadow); text-align: center;
        }

        .avatar { 
            width: 100px; height: 100px; background: var(--primary); 
            color: var(--white); border-radius: 50%; display: flex; 
            align-items: center; justify-content: center; font-size: 36px; 
            font-weight: 800; margin: 0 auto 15px; border: 4px solid var(--accent); 
            overflow: hidden; background-size: cover; background-position: center;
        }

        .info-card { 
            background: rgba(128,128,128,0.06); padding: 14px; 
            border-radius: 12px; margin: 10px 0; text-align: left; 
            border-left: 5px solid var(--primary); 
        }

        .edit-panel {
            margin-top: 20px; padding: 15px; border: 1px solid #eee;
            border-radius: 12px; text-align: left; display: none;
        }

        input {
            width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd;
            border-radius: 8px; box-sizing: border-box; font-size: 13px;
        }

        .btn-action { 
            width: 100%; padding: 14px; margin-top: 8px; border-radius: 10px; 
            border: none; font-weight: 700; cursor: pointer; font-size: 14px;
        }
        .btn-save { background: var(--success); color: white; }
        .btn-edit { background: #eee; color: var(--primary); }
        .btn-back { background: var(--primary); color: white; }

        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="loader-overlay"><p>Loading Archive...</p></div>

    <div class="profile-container">
        <div class="avatar" id="user-avatar">?</div>
        <h2 id="user-name" style="margin: 0; color: var(--primary);">Student Name</h2>
        <p id="user-dept" style="opacity: 0.6; font-size: 13px; margin: 5px 0;">Department</p>

        <div class="info-card">
            <small style="font-weight: 800; opacity: 0.5;">MATRIC NO</small><br>
            <strong id="display-matric">Loading...</strong>
        </div>

        <div id="socials-display" style="display: flex; justify-content: center; gap: 15px; margin: 10px 0;">
            </div>

        <button class="btn-action btn-edit" id="toggle-edit">Edit Profile</button>

        <div id="edit-panel" class="edit-panel">
            <label style="font-size: 11px; font-weight: 700;">G-DRIVE PHOTO LINK</label>
            <input type="text" id="edit-photo" placeholder="Paste link to your photo">
            
            <label style="font-size: 11px; font-weight: 700;">INSTAGRAM USERNAME</label>
            <input type="text" id="edit-ig" placeholder="@username">
            
            <label style="font-size: 11px; font-weight: 700;">TIKTOK USERNAME</label>
            <input type="text" id="edit-tt" placeholder="@username">

            <button class="btn-action btn-save" onclick="saveProfile()">Update Archive</button>
        </div>

        <button class="btn-action btn-back" style="margin-top: 20px;" onclick="window.location.href='index.html'">Go to Vault</button>
        <button class="btn-action" style="background:none; font-size:12px; color:gray;" onclick="handleLogout()">Sign Out</button>
    </div>

    <script>
        // FIREBASE CONFIG
        const firebaseConfig = {
          apiKey: "AIzaSyC0QC_qi2aKIIT5axmN5rk-3igybyxoqW0",
          authDomain: "biuarchive.firebaseapp.com",
          databaseURL: "https://biuarchive-default-rtdb.firebaseio.com",
          projectId: "biuarchive",
          storageBucket: "biuarchive.firebasestorage.app",
          messagingSenderId: "137837754242",
          appId: "1:137837754242:web:4da8aa153cd505e6de019b",
          measurementId: "G-9KYG7N5F1T"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        const editBtn = document.getElementById('toggle-edit');
        const editPanel = document.getElementById('edit-panel');

        editBtn.onclick = () => {
            editPanel.style.display = editPanel.style.display === 'block' ? 'none' : 'block';
        };

        async function loadProfile() {
            auth.onAuthStateChanged(async (user) => {
                if (!user) { 
                    window.location.href = 'login.html'; 
                    return; 
                }

                // Get user data from Firebase Realtime DB
                const userRef = db.ref('users/' + user.uid);
                userRef.once('value', (snapshot) => {
                    const userData = snapshot.val() || {};
                    
                    document.getElementById('user-name').innerText = user.displayName || 'Student';
                    document.getElementById('user-dept').innerText = userData.department || 'Department';
                    document.getElementById('display-matric').innerText = userData.matric_no || 'Loading...';
                    
                    // Set initial or Photo
                    if (userData.profilePic) {
                        document.getElementById('user-avatar').style.backgroundImage = `url('${userData.profilePic}')`;
                        document.getElementById('user-avatar').innerText = '';
                    } else {
                        document.getElementById('user-avatar').innerText = (user.displayName || 'S').charAt(0);
                    }

                    // Display Social Icons
                    const socials = document.getElementById('socials-display');
                    socials.innerHTML = '';
                    if(userData.instagram) socials.innerHTML += `<a href="https://instagram.com/${userData.instagram.replace('@','')}" target="_blank">ðŸ“¸</a>`;
                    if(userData.tiktok) socials.innerHTML += `<a href="https://tiktok.com/@${userData.tiktok.replace('@','')}" target="_blank">ðŸŽµ</a>`;
                    if(userData.linkedin) socials.innerHTML += `<a href="${userData.linkedin}" target="_blank">ðŸ’¼</a>`;

                    // Pre-fill edit inputs
                    document.getElementById('edit-photo').value = userData.profilePic || '';
                    document.getElementById('edit-ig').value = userData.instagram || '';
                    document.getElementById('edit-tt').value = userData.tiktok || '';

                    document.getElementById('loader-overlay').style.display = 'none';
                });
            });
        }

        async function saveProfile() {
            const user = auth.currentUser;
            if(!user) { alert('Not authenticated'); return; }

            const photo = document.getElementById('edit-photo').value;
            const ig = document.getElementById('edit-ig').value;
            const tt = document.getElementById('edit-tt').value;

            try {
                await db.ref('users/' + user.uid).update({
                    profilePic: photo,
                    instagram: ig,
                    tiktok: tt
                });

                alert("Archive Updated!");
                location.reload();
            } catch (err) {
                alert("Error: " + err.message);
            }
        }

        async function handleLogout() {
            await auth.signOut();
            window.location.href = 'login.html';
        }

        loadProfile();
    </script>
    <script src="theme.js" defer></script>
</body>
</html>