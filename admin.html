<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIU Archive | Admin Panel</title>
    <style>
        :root { --primary: #002147; --accent: #FFD700; --bg: #f8f9fa; --danger: #dc3545; --success: #28a745; --info: #17a2b8; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .admin-container { max-width: 1100px; margin: auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: var(--primary); color: white; padding: 15px; border-radius: 12px; text-align: center; border-bottom: 4px solid var(--accent); }
        .stat-card h2 { margin: 0; font-size: 2rem; }
        .stat-card p { margin: 5px 0 0; font-size: 11px; text-transform: uppercase; opacity: 0.8; }

        .tool-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        .tool-card { background: white; border: 1px solid #ddd; padding: 20px; border-radius: 15px; }
        
        .maintenance-card { background: #1a1a1a; color: white; padding: 20px; border-radius: 15px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; border-left: 10px solid var(--danger); }
        
        .table-wrapper { overflow-x: auto; background: white; border-radius: 10px; margin-top: 20px; max-height: 500px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f1f1f1; color: var(--primary); padding: 12px; text-align: left; position: sticky; top: 0; }
        td { padding: 10px 12px; border-bottom: 1px solid #eee; font-size: 13px; }

        .btn { padding: 10px 15px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; display: inline-block; }
        .btn-broadcast { background: var(--info); color: white; width: 100%; margin-top: 10px; }
        .btn-sync { background: var(--success); color: white; width: 100%; margin-top: 10px; }
        .btn-streak { background: #6f42c1; color: white; padding: 5px 10px; font-size: 11px; }
        .btn-ban { background: #000; color: white; padding: 5px 10px; font-size: 11px; }
        .btn-clear { background: #666; color: white; width: 100%; margin-top: 5px; font-size: 12px; }
        
        .sync-stamp { font-size: 11px; color: #666; margin-top: 5px; display: block; }
        .loading-sync { background: #888 !important; cursor: not-allowed; opacity: 0.7; }
    </style>
</head>
<body>

    <div id="admin-content" class="admin-container" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
             <h1 style="color: var(--primary); margin:0;">Celebrity's Control Room</h1>
             <div style="display:flex; gap:10px; align-items:center;">
                <button onclick="nuclearClear()" style="background:none; border:1px solid #ccc; color:red; font-size:10px; cursor:pointer; padding:5px; border-radius:5px;">‚ò¢Ô∏è Nuclear Wipe Logs</button>
                <button onclick="clearChat()" style="background:none; border:1px solid #ccc; color:orange; font-size:10px; cursor:pointer; padding:5px; border-radius:5px;">üí¨ Clear Chat</button>
                <a href="index.html" style="text-decoration:none; font-weight:bold; color:var(--info); font-size:13px;">üè† Student Portal</a>
             </div>
        </div>
        <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">

        <div class="maintenance-card">
            <div>
                <h3 style="margin:0">üõ†Ô∏è System Lock</h3>
                <p style="margin:5px 0 0 0; font-size: 12px; opacity:0.8;">Instantly block all students from the archive.</p>
            </div>
            <button id="m-toggle-btn" class="btn" onclick="toggleMaintenance()">Loading...</button>
        </div>

        <div class="stats-row">
            <div class="stat-card"> <h2 id="count">0</h2> <p>Login Logs</p> </div>
            <div class="stat-card" style="background: var(--info);"> <h2 id="online-count">0</h2> <p>Online Now</p> </div>
            <div class="stat-card" style="background: #6f42c1;"> <h2 id="top-streak">0</h2> <p>High Streak</p> </div>
            <div class="stat-card" style="background: var(--danger);"> <h2 id="banned-count">0</h2> <p>Banned</p> </div>
        </div>

        <div class="tool-grid">
            <div class="tool-card">
                <h3 style="margin:0">üì¢ Global Broadcast (Upgraded)</h3>
                <p style="font-size: 12px; color: #666;">Students will hear a <b>"Ding"</b> notification sound.</p>
                <input type="text" id="alert-msg" placeholder="Type announcement here..." style="width:100%; padding:10px; margin-top:10px; border:1px solid #ddd; border-radius:8px; box-sizing: border-box;">
                <button class="btn btn-broadcast" onclick="sendGlobalAlert()">üöÄ Push & Sound Alert</button>
                <button class="btn btn-clear" onclick="clearBroadcast()">Remove Alert from Screens</button>
            </div>

            <div class="tool-card">
                <h3 style="margin:0">üìä Sheet Sync Status</h3>
                <p style="font-size: 12px; color: #666;">This triggers your Google Apps Script.</p>
                <span id="sync-time" class="sync-stamp">Last Sync: Never</span>
                <button id="sync-btn" class="btn btn-sync" onclick="markSheetSynced()">Confirm Spreadsheet Update</button>
                <a href="https://docs.google.com/spreadsheets/d/1RDC9EBFjF2a9sSMakA5JzMgIBZ9p0oz0/edit" target="_blank" style="display:block; margin-top:10px; font-size:11px; color:var(--info);">üîó Open Google Sheet</a>
            </div>
        </div>

        <div style="background: #fff; border:1px solid #ddd; padding:20px; border-radius:15px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0">Live Activity Feed</h3>
                <input type="text" id="admin-search" placeholder="Search by name or matric..." onkeyup="filterTable()" style="width:40%; padding:8px; border-radius:8px; border:1px solid #ddd;">
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr><th>Student</th><th>Matric</th><th>Streak</th><th>Time</th><th>Action</th></tr>
                    </thead>
                    <tbody id="log-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, remove, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    
        const firebaseConfig = {
            apiKey: "AIzaSyBmZDLDyQ2YhMxsYal1q4d0hyr03VXEqak",
            authDomain: "biu-archive.firebaseapp.com",
            databaseURL: "https://biu-archive-default-rtdb.firebaseio.com",
            projectId: "biu-archive",
            storageBucket: "biu-archive.firebasestorage.app",
            messagingSenderId: "245967347998",
            appId: "1:245967347998:web:a8feb5ad0ef9650946a90f"
        };
    
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby5R8wF2fO7-Sa0bjWoDXxbrocOBAsZqtAD-ddyXNdSAx48L1mgK5Hiep64QzcrusTr/exec";
    
        // Security Check
        const pass = prompt("Enter Celebrity Access Key:");
        if (pass !== "BIU2026") { 
            window.location.href = "index.html"; 
        } else { 
            document.getElementById('admin-content').style.display = 'block'; 
            startAdmin(); 
        }
    
        function startAdmin() {
            // 1. BROADCAST FIX: Ensure the student side is listening to this EXACT path
            window.sendGlobalAlert = () => {
                const msg = document.getElementById('alert-msg').value;
                if(!msg) return alert("Enter a message!");
                
                // Setting the broadcast at the root "broadcast" node
                set(ref(db, "broadcast"), {
                    message: msg,
                    timestamp: serverTimestamp() // Using server time for accuracy
                }).then(() => {
                    alert("üöÄ Broadcast is now LIVE on student screens!");
                    document.getElementById('alert-msg').value = "";
                });
            };
    
            // 2. LIVE FEED FIX: Listening to "users" instead of "logs" for real-time status
            onValue(ref(db, "users"), (snapshot) => {
                const users = snapshot.val();
                const list = document.getElementById('log-list');
                const logCount = document.getElementById('count');
                
                if(!users) {
                    list.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px;'>No student activity detected yet.</td></tr>";
                    return;
                }
    
                const entries = Object.entries(users);
                logCount.innerText = entries.length;
    
                onValue(ref(db, "banned_users"), (bSnap) => {
                    const banned = bSnap.val() || {};
                    
                    // Sort by last active time so newest appears at top
                    const sortedUsers = entries.sort((a, b) => (b[1].lastActive || 0) - (a[1].lastActive || 0));
    
                    list.innerHTML = sortedUsers.map(([uid, data]) => {
                        const isBanned = banned[uid] === true;
                        const lastSeen = data.lastActive ? new Date(data.lastActive).toLocaleTimeString() : "Unknown";
                        
                        return `
                        <tr>
                            <td><strong>${data.name || 'Anonymous'}</strong></td>
                            <td>${data.matric || 'N/A'}</td>
                            <td style="color:#ff5e00; font-weight:bold;">üî• ${data.streak || 1}</td>
                            <td>${lastSeen}</td>
                            <td>
                                <button class="btn btn-streak" onclick="resetStreak('${uid}')">Reset</button>
                                <button class="btn btn-ban" onclick="toggleBan('${uid}', ${isBanned})">
                                    ${isBanned ? '‚úÖ Unban' : 'üö´ Ban'}
                                </button>
                            </td>
                        </tr>`;
                    }).join('');
                });
            });
    
            // Online Count Estimator (Active in last 5 minutes)
            onValue(ref(db, "users"), (s) => {
                const users = s.val() || {};
                const now = Date.now();
                const active = Object.values(users).filter(u => (now - (u.lastActive || 0)) < 300000).length;
                document.getElementById('online-count').innerText = active;
            });
        }
    
        // Define Global Actions for Buttons
        window.clearBroadcast = () => confirm("Stop the broadcast?") && set(ref(db, "broadcast"), null);
        window.toggleBan = (uid, status) => confirm("Change access for this student?") && set(ref(db, `banned_users/${uid}`), status ? null : true);
        window.resetStreak = (uid) => confirm("Reset this student's streak to 1?") && update(ref(db, `users/${uid}`), { streak: 1 });
        window.clearChat = () => confirm("Delete all chat messages?") && remove(ref(db, "messages"));
    </script>
</body>
</html>