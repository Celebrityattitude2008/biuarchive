<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BIU Archive | Admin Panel</title>
    <style>
        :root { 
            --primary: #002147; 
            --accent: #FFD700; 
            --bg: #f8f9fa; 
            --danger: #dc3545; 
            --success: #28a745; 
            --info: #17a2b8; 
        }
        
        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            background: var(--bg); 
            margin: 0; 
            padding: 10px; 
            color: #333;
        }

        .admin-container { 
            max-width: 1100px; 
            margin: 10px auto; 
            background: white; 
            padding: 20px; 
            border-radius: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
            box-sizing: border-box;
        }
        
        /* Stats Section */
        .stats-row { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
            gap: 12px; 
            margin-bottom: 25px; 
        }
        .stat-card { 
            background: var(--primary); 
            color: white; 
            padding: 20px 10px; 
            border-radius: 12px; 
            text-align: center; 
            border-bottom: 4px solid var(--accent); 
        }
        .stat-card h2 { margin: 0; font-size: 1.8rem; }
        .stat-card p { margin: 5px 0 0; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8; }

        /* Tool Grid */
        .tool-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
            margin-bottom: 25px; 
        }
        .tool-card { 
            background: #fff; 
            border: 1px solid #eee; 
            padding: 20px; 
            border-radius: 15px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        }
        
        .maintenance-card { 
            background: #1a1a1a; 
            color: white; 
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 25px; 
            display: flex; 
            flex-wrap: wrap;
            justify-content: space-between; 
            align-items: center; 
            border-left: 8px solid var(--danger); 
            gap: 15px;
        }
        
        /* Table Styles */
        .table-wrapper { 
            overflow-x: auto; 
            background: white; 
            border-radius: 12px; 
            margin-top: 10px; 
            border: 1px solid #eee;
        }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background: #f8f9fa; color: var(--primary); padding: 15px; text-align: left; font-size: 12px; text-transform: uppercase; border-bottom: 2px solid #eee; }
        td { padding: 12px 15px; border-bottom: 1px solid #f1f1f1; font-size: 13px; }

        /* Buttons */
        .btn { 
            padding: 12px 18px; 
            border-radius: 10px; 
            border: none; 
            cursor: pointer; 
            font-weight: bold; 
            transition: all 0.2s; 
            display: inline-block; 
            text-align: center;
        }
        .btn:active { transform: scale(0.96); }
        .btn-broadcast { background: var(--info); color: white; width: 100%; margin-top: 10px; }
        .btn-sync { background: var(--success); color: white; width: 100%; margin-top: 10px; }
        .btn-streak { background: #f1f1f1; color: #6f42c1; padding: 6px 12px; font-size: 11px; }
        .btn-ban { background: #000; color: white; padding: 6px 12px; font-size: 11px; }
        .btn-clear { background: #f8f9fa; color: #666; width: 100%; margin-top: 8px; font-size: 12px; border: 1px solid #ddd; }
        
        input[type="text"] {
            width: 100%; 
            padding: 12px; 
            border: 1.5px solid #eee; 
            border-radius: 10px; 
            box-sizing: border-box;
            outline: none;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus { border-color: var(--info); }

        /* Responsive Overrides */
        @media (max-width: 600px) {
            .admin-container { padding: 15px; border-radius: 0; margin: 0; }
            .header-flex { flex-direction: column; gap: 15px; text-align: center; }
            .header-btns { flex-wrap: wrap; justify-content: center; }
            .tool-grid { grid-template-columns: 1fr; }
            .maintenance-card { text-align: center; justify-content: center; }
            .maintenance-card div { width: 100%; }
        }
    </style>
</head>
<body>

    <div id="admin-content" class="admin-container" style="display:none;">
        <div class="header-flex" style="display:flex; justify-content:space-between; align-items:center;">
             <h1 style="color: var(--primary); margin:0; font-size: 1.5rem;">Celebrity Control Room</h1>
             <div class="header-btns" style="display:flex; gap:8px; align-items:center;">
                <button onclick="nuclearClear()" style="background:none; border:1px solid #ffcccc; color:red; font-size:10px; cursor:pointer; padding:6px; border-radius:8px;">‚ò¢Ô∏è Wipe Logs</button>
                <button onclick="clearChat()" style="background:none; border:1px solid #ffe5cc; color:orange; font-size:10px; cursor:pointer; padding:6px; border-radius:8px;">üí¨ Clear Chat</button>
                <a href="index.html" style="text-decoration:none; font-weight:bold; color:var(--info); font-size:12px; border: 1px solid var(--info); padding: 5px 10px; border-radius: 8px;">üè† Portal</a>
             </div>
        </div>
        <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">

        <div class="maintenance-card">
            <div>
                <h3 style="margin:0">üõ†Ô∏è System Lock</h3>
                <p style="margin:5px 0 0 0; font-size: 12px; opacity:0.8;">Instantly block all students from the archive.</p>
            </div>
            <button id="m-toggle-btn" class="btn" style="min-width: 120px;" onclick="toggleMaintenance()">Loading...</button>
        </div>

        <div class="stats-row">
            <div class="stat-card"> <h2 id="count">0</h2> <p>Total Users</p> </div>
            <div class="stat-card" style="background: var(--info);"> <h2 id="online-count">0</h2> <p>Online Now</p> </div>
            <div class="stat-card" style="background: #6f42c1;"> <h2 id="top-streak">0</h2> <p>High Streak</p> </div>
            <div class="stat-card" style="background: var(--danger);"> <h2 id="banned-count">0</h2> <p>Banned</p> </div>
        </div>

        <div class="tool-grid">
            <div class="tool-card">
                <h3 style="margin:0">üì¢ Global Broadcast</h3>
                <p style="font-size: 12px; color: #666; margin-bottom: 15px;">Students will receive a real-time alert bar.</p>
                <input type="text" id="alert-msg" placeholder="Type announcement here...">
                <button class="btn btn-broadcast" onclick="sendGlobalAlert()">üöÄ Push Sound & Alert</button>
                <button class="btn btn-clear" onclick="clearBroadcast()">Clear Live Screens</button>
            </div>

            <div class="tool-card">
                <h3 style="margin:0">üìä Sheet Sync Status</h3>
                <p style="font-size: 12px; color: #666; margin-bottom: 15px;">Refresh external data sources.</p>
                <span id="sync-time" style="font-size: 11px; color: #999; display: block; margin-bottom: 5px;">Last Sync: Never</span>
                <button id="sync-btn" class="btn btn-sync" onclick="markSheetSynced()">Confirm Update</button>
                <a href="https://docs.google.com/spreadsheets/d/1RDC9EBFjF2a9sSMakA5JzMgIBZ9p0oz0/edit" target="_blank" style="display:block; text-align:center; margin-top:12px; font-size:11px; color:var(--info); text-decoration:none;">üîó Open Google Sheet</a>
            </div>
        </div>

        <div style="background: #fff; border:1px solid #eee; padding:20px; border-radius:15px; box-shadow: 0 4px 6px rgba(0,0,0,0.02);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap: wrap; gap: 10px;">
                <h3 style="margin:0">Live Activity Feed</h3>
                <input type="text" id="admin-search" placeholder="Search name or matric..." onkeyup="filterTable()" style="max-width:250px;">
            </div>
            <div class="table-wrapper">
                <table id="adminTable">
                    <thead>
                        <tr><th>Student</th><th>Matric</th><th>Streak</th><th>Time</th><th>Action</th></tr>
                    </thead>
                    <tbody id="log-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, remove, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    
        const firebaseConfig = {
            apiKey: "AIzaSyBmZDLDyQ2YhMxsYal1q4d0hyr03VXEqak",
            authDomain: "biu-archive.firebaseapp.com",
            databaseURL: "https://biu-archive-default-rtdb.firebaseio.com",
            projectId: "biu-archive",
            storageBucket: "biu-archive.firebasestorage.app",
            messagingSenderId: "245967347998",
            appId: "1:245967347998:web:a8feb5ad0ef9650946a90f"
        };
    
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
    
        // Security Check
        const pass = prompt("Enter Celebrity Access Key:");
        if (pass !== "BIU2026") { 
            window.location.href = "index.html"; 
        } else { 
            document.getElementById('admin-content').style.display = 'block'; 
            startAdmin(); 
        }
    
        function startAdmin() {
            // BROADCAST: Pushing to "broadcast" node for Index.html to see
            window.sendGlobalAlert = () => {
                const msg = document.getElementById('alert-msg').value;
                if(!msg) return alert("Enter a message!");
                
                set(ref(db, "broadcast"), {
                    message: msg,
                    timestamp: serverTimestamp()
                }).then(() => {
                    alert("üöÄ Broadcast Sent!");
                    document.getElementById('alert-msg').value = "";
                });
            };

            // Toggle Maintenance Mode
            window.toggleMaintenance = () => {
                const mRef = ref(db, "maintenance_mode");
                onValue(mRef, (s) => {
                    const current = s.val();
                    set(mRef, !current);
                }, { onlyOnce: true });
            };

            onValue(ref(db, "maintenance_mode"), (s) => {
                const btn = document.getElementById('m-toggle-btn');
                if(s.val() === true) {
                    btn.innerText = "LOCKED";
                    btn.style.background = "var(--danger)";
                } else {
                    btn.innerText = "ACTIVE";
                    btn.style.background = "var(--success)";
                }
            });

            // Feed & Table
            onValue(ref(db, "users"), (snapshot) => {
                const users = snapshot.val();
                const list = document.getElementById('log-list');
                if(!users) return list.innerHTML = "<tr><td colspan='5'>No users yet</td></tr>";

                const entries = Object.entries(users);
                document.getElementById('count').innerText = entries.length;

                onValue(ref(db, "banned_users"), (bSnap) => {
                    const banned = bSnap.val() || {};
                    document.getElementById('banned-count').innerText = Object.keys(banned).length;

                    const sorted = entries.sort((a,b) => (b[1].lastActive || 0) - (a[1].lastActive || 0));
                    list.innerHTML = sorted.map(([uid, data]) => {
                        const isBanned = banned[uid] === true;
                        return `
                        <tr>
                            <td><strong>${data.name || 'User'}</strong></td>
                            <td>${data.matric || 'N/A'}</td>
                            <td>üî• ${data.streak || 1}</td>
                            <td>${data.lastActive ? new Date(data.lastActive).toLocaleTimeString() : '---'}</td>
                            <td>
                                <button class="btn btn-streak" onclick="resetStreak('${uid}')">Reset</button>
                                <button class="btn btn-ban" style="background:${isBanned ? 'green':'black'}" onclick="toggleBan('${uid}', ${isBanned})">
                                    ${isBanned ? 'Unban' : 'Ban'}
                                </button>
                            </td>
                        </tr>`;
                    }).join('');
                });
            });

            // Online Estimator
            onValue(ref(db, "users"), (s) => {
                const now = Date.now();
                const active = Object.values(s.val() || {}).filter(u => (now - (u.lastActive || 0)) < 300000).length;
                document.getElementById('online-count').innerText = active;
            });
        }
    
        window.clearBroadcast = () => set(ref(db, "broadcast"), null);
        window.toggleBan = (uid, status) => set(ref(db, `banned_users/${uid}`), status ? null : true);
        window.resetStreak = (uid) => update(ref(db, `users/${uid}`), { streak: 1 });
        window.clearChat = () => confirm("Clear chat?") && remove(ref(db, "messages"));
        window.nuclearClear = () => confirm("DANGER: Wipe all user logs?") && remove(ref(db, "users"));

        window.filterTable = () => {
            let input = document.getElementById("admin-search").value.toUpperCase();
            let rows = document.getElementById("log-list").getElementsByTagName("tr");
            for (let i = 0; i < rows.length; i++) {
                let text = rows[i].textContent || rows[i].innerText;
                rows[i].style.display = text.toUpperCase().indexOf(input) > -1 ? "" : "none";
            }
        }
    </script>
</body>
</html>