<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIU Student Archive | Signup</title>
    <link rel="stylesheet" href="theme.css">
    <script>(function(){try{var t=localStorage.getItem('site-theme')||'dark';document.documentElement.classList.add('theme-'+t);}catch(e){}})();</script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"></script>
    <meta name="google-signin-client_id" content="137837754242-gte1234567890.apps.googleusercontent.com">
    <style>
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: #001a33; 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #333;
        }
        .signup-container {
            background: #ffffff;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 420px;
            position: relative;
        }
        h2 { color: #003366; margin: 0 0 10px; text-align: center; }
        p.subtitle { color: #666; font-size: 14px; text-align: center; margin-bottom: 25px; }
        
        label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px; color: #003366; }
        input, select {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1.5px solid #eee;
            border-radius: 8px;
            box-sizing: border-box;
            transition: border 0.3s;
        }
        input:focus, select:focus { border-color: #003366; outline: none; }

        button {
            width: 100%;
            padding: 14px;
            background-color: #003366;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            margin-top: 10px;
        }
        button:hover { background-color: #0055a4; }
        
        .error-box {
            background: #ffe5e5;
            color: #cc0000;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 15px;
            display: none;
            text-align: center;
        }

        /* AUTHENTICATING OVERLAY */
        #auth-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 26, 51, 0.9);
            backdrop-filter: blur(8px);
            z-index: 999;
            display: none; 
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: #FFD700;
            border-radius: 50%;
            animation: rotation 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } 
        
        .blink-text {
            font-weight: 800;
            letter-spacing: 2px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* SUCCESS TOAST */
        #success-toast {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: #22c55e;
            color: white;
            padding: 16px 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: top 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #success-toast.show { top: 30px; }

        .login-link {
            text-align: center;
            margin-top: 20px;
            font-size: 13px;
        }
        .login-link a {
            color: #003366;
            text-decoration: none;
            font-weight: 700;
        }
    </style>
</head>
<body>

<div id="auth-overlay">
    <span class="loader"></span>
    <div class="blink-text">INITIALIZING ACCOUNT...</div>
</div>

<div id="success-toast">
    <span style="font-size: 24px;">üöÄ</span>
    <div style="text-align: left;">
        <div style="font-weight: 700;">REGISTRATION SUCCESSFUL!</div>
        <div style="font-size: 10px; opacity: 0.9;">Vault access granted. Redirecting...</div>
    </div>
</div>

<div class="signup-container">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
            <h2 style="margin:0">The BIU Archive</h2>
            <div class="theme-toggle" style="margin-left:auto">
                <label style="font-weight:700;font-size:12px;margin-right:8px">Theme</label>
                <select id="themeSelect" aria-label="Theme selection">
                    <option value="dark">BIU Dark</option>
                    <option value="light">Light Mode</option>
                </select>
            </div>
        </div>
    <p class="subtitle">Secure your academic legacy</p>
    
    <div id="error-box" class="error-box"></div>

    <form id="signupForm">
        <label>Full Name</label>
        <input type="text" id="full_name" placeholder="John Doe" required>

        <label>Student Email</label>
        <input type="email" id="email" placeholder="student@biu.edu.ng" required>

        <div style="display: flex; gap: 10px;">
            <div style="flex: 1;">
                <label>Password</label>
                <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6" required>
            </div>
            <div style="flex: 1;">
                <label>Confirm</label>
                <input type="password" id="confirm_password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
            </div>
        </div>

        <label>Department</label>
        <select id="dept" required onchange="updatePlaceholder()">
            <option value="">-- Select Dept --</option>
            <option value="Computer Science">Computer Science</option>
            <option value="Nursing">Nursing</option>
            <option value="MedLab">MedLab</option>
            <option value="Medicine">Medicine</option>
            <option value="Engineering">Engineering</option>
            <option value="Law">Law</option>
            <option value="ISD">ISD</option>
        </select>

        <label>Matric Number</label>
        <input type="text" id="matric_no" placeholder="Enter Matric Number" required>

        <button type="submit" id="submitBtn">CREATE VAULT IDENTITY</button>

        <div style="margin: 20px 0; position: relative; text-align: center;">
            <span style="background: #ffffff; padding: 0 10px; position: relative; z-index: 1; color: #666; font-size: 12px; font-weight: 600;">OR</span>
            <div style="position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: #eee; z-index: 0;"></div>
        </div>

        <button type="button" onclick="signUpWithGoogle()" style="background-color: #ffffff; color: #003366; border: 2px solid #eee; display: flex; align-items: center; justify-content: center; gap: 10px;">
            <span style="font-size: 18px;">üîê</span> Sign Up with Google
        </button>

        <div class="login-link">
            Already a member? <a href="login.html">Login here</a>
        </div>
    </form>
</div>

<script>
    // FIREBASE CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyC0QC_qi2aKIIT5axmN5rk-3igybyxoqW0",
      authDomain: "biuarchive.firebaseapp.com",
      databaseURL: "https://biuarchive-default-rtdb.firebaseio.com",
      projectId: "biuarchive",
      storageBucket: "biuarchive.firebasestorage.app",
      messagingSenderId: "137837754242",
      appId: "1:137837754242:web:4da8aa153cd505e6de019b",
      measurementId: "G-9KYG7N5F1T"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const errorBox = document.getElementById('error-box');
    const authOverlay = document.getElementById('auth-overlay');
    const successToast = document.getElementById('success-toast');

    // Google Sign-Up Handler
    async function signUpWithGoogle() {
        authOverlay.style.display = "flex";
        try {
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.addScope('profile');
            provider.addScope('email');
            const result = await auth.signInWithPopup(provider);
            const user = result.user;
            
            // Save Google user to Realtime Database
            await db.ref('users/' + user.uid).set({
                full_name: user.displayName || user.email.split('@')[0],
                email: user.email,
                department: "Not Set",
                matric_no: "GOOGLE_AUTH",
                isVerified: false,
                preferredTheme: 'dark',
                streak: 0,
                profilePic: user.photoURL || '',
                createdAt: firebase.database.ServerValue.TIMESTAMP
            });

            authOverlay.style.display = "none";
            successToast.classList.add('show');
            setTimeout(() => { window.location.href = 'index.html'; }, 2000);
        } catch (err) {
            authOverlay.style.display = "none";
            errorBox.innerText = "Google Sign-Up Error: " + err.message;
            errorBox.style.display = "block";
        }
    }

    function updatePlaceholder() {
        const dept = document.getElementById('dept').value;
        const matricInput = document.getElementById('matric_no');
        const hints = {
            "Computer Science": "SCN/CSC/...",
            "Nursing": "AHS/NUR/...",
            "MedLab": "AHS/MLS/...",
            "Medicine": "MED/..."
        };
        matricInput.placeholder = hints[dept] || "Enter Matric Number";
    }

    document.getElementById('signupForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        errorBox.style.display = "none";

        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const confirm_password = document.getElementById('confirm_password').value;
        const full_name = document.getElementById('full_name').value;
        const dept = document.getElementById('dept').value;
        const matric = document.getElementById('matric_no').value.toUpperCase();

        // Password Match Check
        if (password !== confirm_password) {
            errorBox.innerText = "Passwords do not match!";
            errorBox.style.display = "block";
            return;
        }

        // Matric Validation
        let validationError = "";
        if (dept === "Computer Science" && !matric.startsWith("SCN/CSC/")) validationError = "CSC Matric must start with SCN/CSC/";
        else if (dept === "Nursing" && !matric.startsWith("AHS/NUR/")) validationError = "Nursing Matric must start with AHS/NUR/";
        else if (dept === "MedLab" && !matric.startsWith("AHS/MLS/")) validationError = "MedLab Matric must start with AHS/MLS/";
        else if (dept === "Medicine" && !matric.startsWith("MED/")) validationError = "Medicine Matric must start with MED/";

        if (validationError) {
            errorBox.innerText = validationError;
            errorBox.style.display = "block";
            return;
        }

        authOverlay.style.display = "flex";

        try {
            // Create Firebase Auth User
            const { user } = await auth.createUserWithEmailAndPassword(email, password);
            
            // Update display name
            await user.updateProfile({ displayName: full_name });
            
            // Store user data in Realtime Database
            await db.ref('users/' + user.uid).set({
                full_name: full_name,
                email: email,
                department: dept,
                matric_no: matric,
                isVerified: false,
                preferredTheme: 'dark',
                streak: 0,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            });

            authOverlay.style.display = "none";
            successToast.classList.add('show');

            setTimeout(() => {
                window.location.href = 'login.html';
            }, 3000);

        } catch (err) {
            authOverlay.style.display = "none";
            errorBox.innerText = err.message;
            errorBox.style.display = "block";
        }
    });
</script>
<script src="theme.js" defer></script>
<script>
    // Wire the theme selector
    (function(){
        const sel = document.getElementById('themeSelect');
        try{
            const stored = localStorage.getItem('site-theme') || 'dark';
            sel.value = stored;
        }catch(e){ }

        sel.addEventListener('change', (e)=>{
            const val = e.target.value === 'light' ? 'light' : 'dark';
            try{ localStorage.setItem('site-theme', val); }catch(_){}
            // apply immediately
            document.documentElement.classList.remove('theme-dark','theme-light');
            document.documentElement.classList.add('theme-'+val);
        });
    })();
</script>
<script src="theme.js" defer></script>
</body>
</html>