<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The BIU Archive | Student Portal</title>
    <style>
        :root {
            --primary: #002147; --accent: #FFD700; --light: #f4f4f4;
            --white: #ffffff; --text: #333; --success: #28a745; --info: #17a2b8;
            --dark-menu: #1e1e1e;
        }
        [data-theme="dark"] {
            --primary: #FFD700; --accent: #002147; --light: #121212;
            --white: #1e1e1e; --text: #f4f4f4;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--light); color: var(--text); margin: 0; display: flex; justify-content: center; padding: 20px; transition: 0.3s; }
        .container { background: var(--white); padding: 2rem; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 850px; text-align: center; position: relative; }
        .hidden { display: none !important; }
        
        /* MAINTENANCE OVERLAY */
        #maintenance-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; text-align: center; padding: 20px; box-sizing: border-box; }

        /* NAV SYSTEM */
        .top-nav { position: absolute; top: 15px; right: 15px; display: flex; gap: 8px; z-index: 100; align-items: center; }
        .nav-btn { padding: 8px 12px; border-radius: 20px; border: none; cursor: pointer; font-size: 11px; font-weight: bold; background: var(--primary); color: var(--white); transition: 0.2s; }
        
        /* DROPDOWN MENU UI */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { 
            display: none; 
            position: absolute; 
            right: 0; 
            top: 40px; 
            background-color: var(--dark-menu); 
            min-width: 180px; 
            box-shadow: 0px 8px 16px rgba(0,0,0,0.3); 
            border-radius: 10px; 
            overflow: hidden; 
            z-index: 101; 
        }
        .dropdown-content button { 
            color: white; 
            padding: 12px 16px; 
            display: block; 
            width: 100%; 
            border: none; 
            background: none; 
            text-align: left; 
            font-size: 13px; 
            cursor: pointer; 
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .dropdown-content button:hover { background-color: #333; }
        .show { display: block !important; }

        /* DASHBOARD ELEMENTS */
        .marketplace-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin: 15px 0; }
        .ad-card { background: linear-gradient(145deg, var(--white), var(--light)); border: 1px solid var(--accent); padding: 12px; border-radius: 10px; font-size: 12px; text-align: left; cursor: pointer; position: relative; }
        .ad-tag { position: absolute; top: 5px; right: 5px; font-size: 8px; background: var(--accent); color: var(--primary); padding: 2px 5px; border-radius: 4px; font-weight: bold; }
        
        /* SKELETON ANIMATION */
        .skeleton { background: #eee; background: linear-gradient(110deg, #ececec 8%, #f5f5f5 18%, #ececec 33%); border-radius: 5px; background-size: 200% 100%; animation: 1.5s shine linear infinite; }
        @keyframes shine { to { background-position-x: -200%; } }
        .skeleton-text { height: 12px; width: 80%; margin-top: 5px; }

        #broadcast-bar { background: #FFD700; color: #002147; padding: 12px; border-radius: 10px; margin-top: 50px; margin-bottom: 15px; font-weight: bold; border-left: 5px solid #002147; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 25px 0; }
        .timetable-box, .study-advice { background: rgba(128, 128, 128, 0.05); border: 1px solid rgba(0,0,0,0.1); padding: 15px; border-radius: 12px; text-align: left; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; }
        th { background: var(--primary); color: var(--white); padding: 8px; text-align: left; }
        td { border-bottom: 1px solid rgba(0,0,0,0.05); padding: 8px; }
        .chat-section { margin-top: 30px; background: rgba(0,0,0,0.03); padding: 20px; border-radius: 15px; text-align: left; }
        #chat-display { height: 180px; overflow-y: auto; background: var(--white); border-radius: 8px; padding: 10px; border: 1px solid rgba(0,0,0,0.1); font-size: 13px; border-left: 4px solid var(--accent); }
        .chat-input-area { display: flex; gap: 5px; margin-top: 10px; }
        .chat-input-area input { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #ccc; }
        #typing-indicator { font-size: 11px; color: var(--info); height: 15px; margin-top: 5px; font-style: italic; }
        footer { margin-top: 40px; font-size: 12px; opacity: 0.8; padding-top: 20px; border-top: 1px solid rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <div id="maintenance-screen" class="hidden">
        <h1 style="color: var(--accent); font-size: 3rem;">üöß</h1>
        <h2>Scheduled Maintenance</h2>
        <p>The BIU Archive is currently undergoing updates.<br>We will be back shortly!</p>
    </div>

    <div id="main-archive" class="container">
        <div class="top-nav">
            <span id="user-count-badge" style="background:var(--success); color:white; padding: 4px 10px; border-radius:20px; font-size:10px;">‚óè <span id="online-count">1</span> Online</span>
            
            <div class="dropdown">
                <button class="nav-btn" onclick="toggleDropdown()">‚ò∞ Menu</button>
                <div id="myDropdown" class="dropdown-content">
                    <button onclick="window.location.href='pq.html'">üìÑ Past Questions</button>
                    <button onclick="window.location.href='note.html'">üìö Course Notes</button>
                    <button onclick="window.location.href='lost.html'">üîç Lost & Found</button>
                    <button onclick="contactAdmin()">üìß Contact Admin</button>
                    <button onclick="toggleTheme()">üåì Toggle Theme</button>
                    <button onclick="window.location.href='admin.html'">‚öôÔ∏è Admin Panel</button>
                    <button style="color: #ff4d4d;" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
        
        <div id="broadcast-bar" class="hidden">
            <span>üì¢ <span id="live-broadcast-text"></span></span>
            <button onclick="this.parentElement.classList.add('hidden')" style="background:none; border:none; cursor:pointer; font-weight:bold; color:var(--primary);">‚úï</button>
        </div>

        <h1 id="header-title" style="margin-top: 60px;">BIU Portal</h1>
        <p><span id="greeting-text">Welcome</span>, <span id="display-name" style="color:var(--info); font-weight:bold;"></span></p>

        <div style="text-align: left; margin-top: 25px;">
            <h4 style="margin: 0; color: var(--primary); font-size: 14px; border-left: 3px solid var(--accent); padding-left: 10px;">üöÄ Campus Services (Sponsored)</h4>
            <div class="marketplace-grid" id="marketplace-grid">
                <div class="ad-card" id="ad1-card">
                    <span class="ad-tag">SERVICE</span>
                    <div id="ad1-loader"><div class="skeleton" style="height:15px; width:60%;"></div><div class="skeleton skeleton-text"></div></div>
                    <strong id="ad1-title" class="hidden"></strong>
                    <p id="ad1-desc" class="hidden" style="margin:5px 0 0 0; opacity:0.7;"></p>
                </div>
                <div class="ad-card" id="ad2-card">
                    <span class="ad-tag">AD</span>
                    <div id="ad2-loader"><div class="skeleton" style="height:15px; width:60%;"></div><div class="skeleton skeleton-text"></div></div>
                    <strong id="ad2-title" class="hidden"></strong>
                    <p id="ad2-desc" class="hidden" style="margin:5px 0 0 0; opacity:0.7;"></p>
                </div>
            </div>
        </div>

        <div class="info-grid">
            <div class="timetable-box">
                <h3>üìÖ Exam Schedule</h3>
                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr><th>Date</th><th>Course</th><th>Venue</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>Mon 02/02</td><td>GST 111</td><td>ICT FOS</td></tr>
                            <tr><td>Tue 03/02</td><td>GST 112</td><td>ICT ENG</td></tr>
                        </tbody>
                    </table>
                </div>
                <button class="nav-btn" style="width: 100%; margin-top: 10px; background: var(--primary);" onclick="window.open('https://drive.google.com/file/d/1RDC9EBFjF2a9sSMakA5JzMgIBZ9p0oz0/view?usp=drivesdk', '_blank')">üì• Download Full Timetable</button>
            </div>
            <div class="study-advice">
                <h3>üí° Quick Access</h3>
                <p>Prepare for exams by visiting our PQ bank below:</p>
                <button class="nav-btn" style="width: 100%; padding: 12px; margin-top: 5px; background: var(--success);" onclick="window.location.href='pq.html'">üìÇ Open Past Questions</button>
            </div>
        </div>

        <div class="chat-section">
            <h3>üí¨ Student Discussion (Live)</h3>
            <div id="chat-display"><em>Connecting to chat...</em></div>
            <div id="typing-indicator"></div>
            <div class="chat-input-area">
                <input type="text" id="chat-msg" placeholder="Type a message..." oninput="handleTyping()">
                <button class="nav-btn" onclick="sendChat()">Send</button>
            </div>
        </div>

        <footer>
            <strong>The BIU Archive</strong><br>
            Benson Idahosa University
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBmZDLDyQ2YhMxsYal1q4d0hyr03VXEqak", 
            authDomain: "biu-archive.firebaseapp.com",
            databaseURL: "https://biu-archive-default-rtdb.firebaseio.com",
            projectId: "biu-archive",
            storageBucket: "biu-archive.firebasestorage.app",
            messagingSenderId: "245967347998",
            appId: "1:245967347998:web:a8feb5ad0ef9650946a90f" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const chatRef = ref(db, "messages");
        const typingRef = ref(db, "typing_status");

        // MAINTENANCE MODE LISTENER (Updates based on Admin panel change)
        onValue(ref(db, "maintenance_mode"), (snapshot) => {
            if (snapshot.val() === true) {
                document.getElementById('maintenance-screen').classList.remove('hidden');
                document.getElementById('main-archive').classList.add('hidden');
            } else {
                document.getElementById('maintenance-screen').classList.add('hidden');
                document.getElementById('main-archive').classList.remove('hidden');
            }
        });

        const hrs = new Date().getHours();
        let greet = "Good Evening üåô";
        if (hrs < 12) greet = "Good Morning ‚òï";
        else if (hrs < 18) greet = "Good Afternoon ‚òÄÔ∏è";
        document.getElementById('greeting-text').innerText = greet;

        const name = localStorage.getItem('biu_user_name');
        if(!name) { window.location.href = 'login.html'; }
        document.getElementById('display-name').innerText = name;

        let typingTimeout;
        window.handleTyping = function() {
            set(ref(db, `typing_status/${name.split(' ')[0]}`), true);
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                set(ref(db, `typing_status/${name.split(' ')[0]}`), null);
            }, 2000);
        };

        onValue(typingRef, (snapshot) => {
            const typers = snapshot.val();
            const indicator = document.getElementById('typing-indicator');
            if (typers) {
                const names = Object.keys(typers).filter(n => n !== name.split(' ')[0]);
                indicator.innerText = names.length > 0 ? `${names.join(', ')} is typing...` : "";
            } else { indicator.innerText = ""; }
        });

        window.toggleDropdown = function() { document.getElementById("myDropdown").classList.toggle("show"); }
        window.onclick = function(e) {
            if (!e.target.matches('.nav-btn')) {
                const d = document.getElementById("myDropdown");
                if (d && d.classList.contains('show')) d.classList.remove('show');
            }
        }

        onValue(ref(db, "broadcast"), (s) => {
            const d = s.val();
            if(d && d.text) {
                document.getElementById('live-broadcast-text').innerText = d.text;
                document.getElementById('broadcast-bar').classList.remove('hidden');
            }
        });

        onValue(ref(db, "marketplace"), (snapshot) => {
            const data = snapshot.val();
            if(data) {
                if(data.ad1) {
                    document.getElementById('ad1-loader').classList.add('hidden');
                    document.getElementById('ad1-title').innerText = data.ad1.title;
                    document.getElementById('ad1-desc').innerText = data.ad1.desc;
                    document.getElementById('ad1-title').classList.remove('hidden');
                    document.getElementById('ad1-desc').classList.remove('hidden');
                    document.getElementById('ad1-card').onclick = () => window.open(data.ad1.link, '_blank');
                }
                if(data.ad2) {
                    document.getElementById('ad2-loader').classList.add('hidden');
                    document.getElementById('ad2-title').innerText = data.ad2.title;
                    document.getElementById('ad2-desc').innerText = data.ad2.desc;
                    document.getElementById('ad2-title').classList.remove('hidden');
                    document.getElementById('ad2-desc').classList.remove('hidden');
                    document.getElementById('ad2-card').onclick = () => window.open(data.ad2.link, '_blank');
                }
            }
        });

        window.contactAdmin = function() { window.location.href = "mailto:pauladamu600@gmail.com"; };
        window.toggleTheme = function() {
            const b = document.body;
            b.setAttribute('data-theme', b.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
        };
        window.logout = function() { localStorage.clear(); window.location.href = 'login.html'; };

        window.sendChat = function() {
            const i = document.getElementById('chat-msg');
            if (i.value.trim() !== "") {
                push(chatRef, { sender: name.split(' ')[0], message: i.value, displayTime: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) });
                set(ref(db, `typing_status/${name.split(' ')[0]}`), null);
                i.value = "";
            }
        };

        onChildAdded(chatRef, (s) => {
            const d = s.val();
            const disp = document.getElementById('chat-display');
            if (disp.innerHTML.includes('Connecting')) disp.innerHTML = '';
            disp.innerHTML += `<div style="margin-bottom:8px;"><strong>${d.sender}</strong> <small style="opacity:0.5">${d.displayTime}</small><br>${d.message}</div>`;
            disp.scrollTop = disp.scrollHeight;
        });
    </script>
</body>
</html>