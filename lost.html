<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lost & Found | BIU Archive</title>
    <link rel="stylesheet" href="theme.css">
    <script>(function(){try{var t=localStorage.getItem('site-theme')||'dark';document.documentElement.classList.add('theme-'+t);}catch(e){}})();</script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"></script>
    <style>
        .bg-biu { background-color: #002147; }
        .text-biu { color: #002147; }
        .bg-gold { background-color: #FFD700; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen pb-24">

    <header class="bg-biu text-white p-6 rounded-b-[2.5rem] shadow-xl text-center mb-6">
        <h1 class="text-2xl font-black uppercase tracking-widest">üîç Lost & Found</h1>
        <p class="text-blue-200 text-xs mt-1">Benson Idahosa University Student Portal</p>
    </header>

    <main class="max-w-md mx-auto px-4">
        
        <button onclick="toggleForm()" class="w-full py-4 bg-gold text-biu font-black rounded-2xl shadow-lg active:scale-95 transition-all mb-6 flex items-center justify-center gap-2">
            <span>‚ûï</span> REPORT FOUND ITEM
        </button>

        <div id="uploadForm" class="hidden bg-white p-6 rounded-3xl shadow-md border border-gray-100 mb-8 space-y-4">
            <h2 class="text-biu font-bold text-sm uppercase tracking-wider">Item Details</h2>
            
            <input type="text" id="itemName" placeholder="What did you find? (e.g. ID Card)" 
                   class="w-full p-4 bg-gray-50 border-none rounded-xl outline-none focus:ring-2 focus:ring-yellow-400">
            
            <input type="text" id="location" placeholder="Found where? (e.g. Heritage Hall)" 
                   class="w-full p-4 bg-gray-50 border-none rounded-xl outline-none">

            <input type="tel" id="founderPhone" placeholder="Your WhatsApp (e.g. 08012345678)" 
                   class="w-full p-4 bg-gray-50 border-none rounded-xl outline-none">
            
            <textarea id="desc" placeholder="Brief description (color, marks, etc.)" 
                      class="w-full p-4 bg-gray-50 border-none rounded-xl outline-none h-24"></textarea>
            
            <div class="space-y-2">
                <label class="block text-[10px] font-black text-gray-400 uppercase ml-1">Attach Photo</label>
                <input type="file" id="itemPhoto" accept="image/*" 
                       class="text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-blue-50 file:text-biu">
            </div>
            
            <button onclick="uploadItem()" id="submitBtn" 
                    class="w-full py-4 bg-biu text-white font-black rounded-xl uppercase tracking-widest text-xs shadow-lg">
                Submit to Archive
            </button>
        </div>

        <div id="itemFeed" class="space-y-6">
            <div class="text-center py-10 text-gray-400 animate-pulse text-sm">Searching the archive...</div>
        </div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-md border-t border-gray-100 p-4 flex justify-around items-center z-50">
        <button onclick="location.href='index.html'" class="flex flex-col items-center gap-1 group">
            <span class="text-xl group-hover:scale-110 transition-transform">üè†</span>
            <span class="text-[10px] font-bold text-gray-400">HOME</span>
        </button>
        <button class="flex flex-col items-center gap-1 group">
            <span class="text-xl group-hover:scale-110 transition-transform">üîç</span>
            <span class="text-[10px] font-bold text-biu">FOUND</span>
        </button>
        <button onclick="location.href='pq.html'" class="flex flex-col items-center gap-1 group">
            <span class="text-xl group-hover:scale-110 transition-transform">üìÑ</span>
            <span class="text-[10px] font-bold text-gray-400">LIBRARY</span>
        </button>
    </nav>

    <script>
        // CLOUDINARY CONFIG
        const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/62b4aeb4d67105010cf35eb3eda61c/image/upload";
        const UPLOAD_PRESET = "biupreset";

        // FIREBASE CONFIG
        const firebaseConfig = {
          apiKey: "AIzaSyC0QC_qi2aKIIT5axmN5rk-3igybyxoqW0",
          authDomain: "biuarchive.firebaseapp.com",
          databaseURL: "https://biuarchive-default-rtdb.firebaseio.com",
          projectId: "biuarchive",
          storageBucket: "biuarchive.firebasestorage.app",
          messagingSenderId: "137837754242",
          appId: "1:137837754242:web:4da8aa153cd505e6de019b",
          measurementId: "G-9KYG7N5F1T"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        function toggleForm() {
            const form = document.getElementById('uploadForm');
            form.classList.toggle('hidden');
            form.scrollIntoView({ behavior: 'smooth' });
        }

        async function uploadItem() {
            const btn = document.getElementById('submitBtn');
            const file = document.getElementById('itemPhoto').files[0];
            const name = document.getElementById('itemName').value;
            const loc = document.getElementById('location').value;
            const phone = document.getElementById('founderPhone').value;
            const description = document.getElementById('desc').value;

            if(!file || !name || !phone) {
                alert("Please provide the Item Name, Phone Number, and a Photo.");
                return;
            }

            btn.innerText = "UPLOADING...";
            btn.disabled = true;

            try {
                // 1. Upload Image to Cloudinary
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', UPLOAD_PRESET);
                
                const cloudinaryRes = await fetch(CLOUDINARY_URL, {
                    method: 'POST',
                    body: formData
                });
                
                if (!cloudinaryRes.ok) throw new Error('Cloudinary upload failed');
                
                const cloudinaryData = await cloudinaryRes.json();
                const imageUrl = cloudinaryData.secure_url;

                // 2. Save to Realtime Database
                await db.ref('lost_found').push({
                    item_name: name,
                    location_found: loc,
                    description: description,
                    founder_phone: phone,
                    image_url: imageUrl,
                    created_at: firebase.database.ServerValue.TIMESTAMP,
                    founderUid: auth.currentUser ? auth.currentUser.uid : 'anonymous'
                });

                alert("Item posted successfully!");
                location.reload();
            } catch (err) {
                alert("Upload Error: " + err.message);
                btn.innerText = "TRY AGAIN";
                btn.disabled = false;
            }
        }

        async function loadFeed() {
            const feedRef = db.ref('lost_found');
            feedRef.orderByChild('created_at').once('value', (snapshot) => {
                const feed = document.getElementById('itemFeed');
                feed.innerHTML = '';
                const items = [];
                snapshot.forEach(child => {
                    items.unshift(child.val()); // Reverse order for latest first
                });

                if (items.length > 0) {
                    items.forEach(item => {
                        feed.innerHTML += `
                            <div class="bg-white rounded-[2rem] overflow-hidden shadow-sm border border-gray-100 transition-all active:scale-[0.98]">
                                ${item.image_url ? `<img src="${item.image_url}" class="w-full h-56 object-cover">` : ''}
                                <div class="p-6">
                                    <div class="flex justify-between items-start mb-2">
                                        <h3 class="font-black text-xl text-biu leading-tight">${item.item_name}</h3>
                                        <span class="bg-blue-50 text-biu text-[9px] font-black px-2 py-1 rounded-md uppercase">New</span>
                                    </div>
                                    <p class="text-xs text-blue-500 font-bold mb-3 flex items-center gap-1">
                                        <span>üìç</span> ${item.location_found || 'Unknown Location'}
                                    </p>
                                    <p class="text-gray-500 text-sm mb-6 leading-relaxed">${item.description || 'No additional description provided.'}</p>
                                    
                                    <button onclick="claimItem('${item.founder_phone.replace(/'/g, "\\'")}', '${item.item_name.replace(/'/g, "\\'")}')" 
                                            class="w-full py-4 bg-green-500 hover:bg-green-600 text-white rounded-2xl font-black text-xs uppercase tracking-[0.15em] shadow-lg shadow-green-100 flex items-center justify-center gap-2">
                                        ‚úÖ This is mine (Claim)
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    feed.innerHTML = `<div class="text-center py-20 text-gray-400 text-sm">No items found yet. Keep an eye out!</div>`;
                }
            });
        }

        function claimItem(phone, itemName) {
            const cleanPhone = phone.replace(/\s+/g, '');
            const msg = `Hello! I'm a BIU student. I saw the "${itemName}" you posted on the BIU Archive. I think it belongs to me. Can we meet?`;
            window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // Initialize
        loadFeed();

        // Real-time listener for new found items (Firebase)
        db.ref('lost_found').on('child_added', () => loadFeed());
    </script>
    <script src="theme.js" defer></script>
</body>
</html>