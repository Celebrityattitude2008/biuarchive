<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Leaderboard | BIU Archive</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #002147; --accent: #FFD700; --light: #f4f4f4;
            --white: #ffffff; --text: #333; --info: #17a2b8; --online: #28a745;
        }
        [data-theme="dark"] {
            --primary: #FFD700; --accent: #002147; --light: #121212;
            --white: #1e1e1e; --text: #f4f4f4;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--light); color: var(--text); margin: 0; display: flex; justify-content: center; padding: 20px; transition: 0.3s; }
        .container { background: var(--white); padding: 2rem; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 600px; text-align: center; }
        
        .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .back-btn, .share-btn { padding: 8px 15px; border-radius: 20px; border: none; cursor: pointer; background: var(--primary); color: var(--white); font-weight: bold; text-decoration: none; font-size: 12px; transition: 0.2s; }
        .share-btn { background: var(--info); margin-top: 10px; width: 100%; display: block; }

        .search-box { width: 100%; padding: 12px; margin-bottom: 20px; border-radius: 10px; border: 1px solid rgba(0,0,0,0.1); background: var(--light); color: var(--text); box-sizing: border-box; outline: none; }

        .loader { width: 30px; height: 30px; border: 3px solid #ddd; border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .leaderboard-list { text-align: left; min-height: 50px; }
        .entry { display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 10px; background: rgba(128,128,128,0.05); border-radius: 10px; border: 1px solid rgba(0,0,0,0.05); transition: 0.2s; }
        .entry-info { display: flex; align-items: center; gap: 15px; }
        
        /* Level Tags */
        .level-tag { font-size: 9px; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; font-weight: bold; margin-left: 5px; }
        .lvl-bronze { background: #cd7f32; color: white; }
        .lvl-silver { background: #c0c0c0; color: #333; }
        .lvl-gold { background: #ffd700; color: #002147; }
        .lvl-diamond { background: #b9f2ff; color: #005f73; }

        /* Online Status */
        .online-dot { width: 8px; height: 8px; background: var(--online); border-radius: 50%; display: inline-block; margin-right: 5px; box-shadow: 0 0 8px var(--online); animation: pulse-online 2s infinite; }
        @keyframes pulse-online { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        .rank-emoji { font-size: 1.4rem; width: 35px; text-align: center; }
        .rank-number { font-weight: bold; color: var(--primary); width: 35px; text-align: center; display: inline-block; }
        
        .name { font-weight: 600; font-size: 1.05rem; }
        .streak { font-weight: bold; color: #ff5e00; }

        @keyframes fireGlow {
            0% { box-shadow: 0 0 10px rgba(255, 69, 0, 0.4); border-color: #ff4500; }
            50% { box-shadow: 0 0 25px rgba(255, 140, 0, 0.6); border-color: #ffd700; }
            100% { box-shadow: 0 0 10px rgba(255, 69, 0, 0.4); border-color: #ff4500; }
        }
        .rank-1 { animation: fireGlow 2s infinite alternate; background: linear-gradient(90deg, rgba(255, 215, 0, 0.15), transparent) !important; }
        .rank-2 { border: 1px solid #C0C0C0 !important; background: linear-gradient(90deg, rgba(192, 192, 192, 0.1), transparent) !important; }
        .rank-3 { border: 1px solid #CD7F32 !important; background: linear-gradient(90deg, rgba(205, 127, 50, 0.1), transparent) !important; }

        .my-rank-card { margin-top: 25px; padding: 20px; background: var(--primary); color: var(--white); border-radius: 12px; text-align: left; position: relative; overflow: hidden; border-bottom: 5px solid var(--accent); }
        .my-rank-card::after { content: 'BIU'; position: absolute; right: -10px; bottom: -10px; font-size: 50px; font-weight: 900; opacity: 0.1; }
        
        .trend-up { color: #28a745; font-size: 11px; font-weight: bold; }
        .trend-down { color: #dc3545; font-size: 11px; font-weight: bold; }
        .sync-time { font-size: 10px; opacity: 0.6; margin-top: 10px; display: block; }

        .match-highlight { border: 2px solid var(--primary) !important; background: rgba(0, 33, 71, 0.1) !important; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <a href="index.html" class="back-btn">‚Üê Back</a>
            <h2 style="margin:0;">üèÜ Top Scholars</h2>
            <div style="width:60px;"></div>
        </div>

        <input type="text" id="searchBar" class="search-box" placeholder="Search student name..." onkeyup="filterLeaderboard()">

        <div id="loading">
            <div class="loader"></div>
            <p style="font-size: 12px; opacity: 0.6;">Fetching live rankings...</p>
        </div>
        
        <div id="leaderboard-full" class="leaderboard-list"></div>
        <div id="personal-rank-container"></div>
        <div id="share-area"></div>

        <footer style="margin-top: 30px; font-size: 12px; opacity: 0.7;">
            The BIU Archive ¬© 2026
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBmZDLDyQ2YhMxsYal1q4d0hyr03VXEqak",
            authDomain: "biu-archive.firebaseapp.com",
            databaseURL: "https://biu-archive-default-rtdb.firebaseio.com",
            projectId: "biu-archive",
            storageBucket: "biu-archive.firebasestorage.app",
            messagingSenderId: "245967347998",
            appId: "1:245967347998:web:a8feb5ad0ef9650946a90f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const leaderboardDiv = document.getElementById('leaderboard-full');
        const personalDiv = document.getElementById('personal-rank-container');
        const loadingDiv = document.getElementById('loading');
        const shareArea = document.getElementById('share-area');

        if (localStorage.getItem('theme') === 'dark') document.body.setAttribute('data-theme', 'dark');

        function getLevelInfo(streak) {
            if (streak >= 30) return { title: "Diamond", class: "lvl-diamond" };
            if (streak >= 15) return { title: "Gold", class: "lvl-gold" };
            if (streak >= 7) return { title: "Silver", class: "lvl-silver" };
            if (streak >= 3) return { title: "Bronze", class: "lvl-bronze" };
            return { title: "Novice", class: "" };
        }

        onValue(ref(db, "users"), (snapshot) => {
            const data = snapshot.val();
            loadingDiv.style.display = 'none';
            
            if (!data) {
                leaderboardDiv.innerHTML = '<div style="text-align:center; opacity:0.5;">No scholars found yet.</div>';
                return;
            }

            const allUsers = Object.entries(data).map(([id, val]) => ({ id, ...val }))
                .filter(u => u.name)
                .sort((a, b) => (b.streak || 0) - (a.streak || 0));

            renderList(allUsers);

            const currentUserId = localStorage.getItem('biu_user_id');
            const myIndex = allUsers.findIndex(u => u.id === currentUserId);

            if (myIndex !== -1) {
                const myData = allUsers[myIndex];
                const myCurrentRank = myIndex + 1;
                const lastRank = localStorage.getItem('biu_last_rank');
                
                let trendHTML = `<span style="font-size:10px; opacity:0.6;">SYNCED</span>`;
                if (lastRank) {
                    const diff = parseInt(lastRank) - myCurrentRank;
                    if (diff > 0) trendHTML = `<span class="trend-up">‚ñ≤ ${diff} Rank Jump!</span>`;
                    else if (diff < 0) trendHTML = `<span class="trend-down">‚ñº ${Math.abs(diff)} Dropped</span>`;
                }
                localStorage.setItem('biu_last_rank', myCurrentRank);

                personalDiv.innerHTML = `
                    <div id="capture-card" class="my-rank-card">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                            <span style="font-size: 9px; letter-spacing:1px; opacity:0.8;">BIU OFFICIAL RANK CARD</span>
                            ${trendHTML}
                        </div>
                        <div style="font-size: 19px; font-weight: bold;">${myData.name}</div>
                        <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-top:5px;">
                            <span style="font-size: 24px; font-weight: 900; color: var(--accent);">Rank #${myCurrentRank}</span>
                            <span style="font-size: 14px;">üî• ${myData.streak || 0} Streak</span>
                        </div>
                    </div>
                    <span class="sync-time">‚è±Ô∏è Verified: ${new Date().toLocaleTimeString()}</span>
                `;
                shareArea.innerHTML = `<button class="share-btn" onclick="captureRank()">üì∏ Save Achievement Image</button>`;
            }
        });

        function renderList(users) {
            const now = Date.now();
            leaderboardDiv.innerHTML = users.map((user, index) => {
                const level = getLevelInfo(user.streak || 0);
                const isOnline = (now - (user.lastActive || 0)) < 60000; // Active within 60s
                
                let rankLabel = `<span class="rank-number">#${index + 1}</span>`;
                let rankClass = "";
                if (index === 0) { rankLabel = `<span class="rank-emoji">ü•á</span>`; rankClass = "rank-1"; }
                if (index === 1) { rankLabel = `<span class="rank-emoji">ü•à</span>`; rankClass = "rank-2"; }
                if (index === 2) { rankLabel = `<span class="rank-emoji">ü•â</span>`; rankClass = "rank-3"; }

                return `
                    <div class="entry ${rankClass}" data-name="${user.name.toLowerCase()}">
                        <div class="entry-info">
                            ${rankLabel}
                            <div>
                                <span class="name">${isOnline ? '<span class="online-dot"></span>' : ''}${user.name}</span>
                                <span class="level-tag ${level.class}">${level.title}</span>
                            </div>
                        </div>
                        <span class="streak">üî• ${user.streak || 0}</span>
                    </div>
                `;
            }).join('');
        }

        window.filterLeaderboard = function() {
            const term = document.getElementById('searchBar').value.toLowerCase();
            document.querySelectorAll('.entry').forEach(item => {
                const name = item.getAttribute('data-name');
                if (name.includes(term)) {
                    item.style.display = 'flex';
                    item.classList.toggle('match-highlight', term !== "");
                } else {
                    item.style.display = 'none';
                }
            });
        };

        window.captureRank = function() {
            const btn = document.querySelector('.share-btn');
            const target = document.getElementById('capture-card');
            btn.innerText = "Processing Image...";
            html2canvas(target, { backgroundColor: null, scale: 3 }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'BIU-Archive-Rank.png';
                link.href = canvas.toDataURL();
                link.click();
                btn.innerText = "üì∏ Save Achievement Image";
            });
        };
    </script>
</body>
</html>