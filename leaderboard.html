<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Global Leaderboard | BIU Archive</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #002147; 
            --accent: #FFD700; 
            --light: #f8f9fa;
            --white: #ffffff; 
            --text: #333; 
            --info: #17a2b8; 
            --online: #28a745;
            --radius: 16px;
            --blue-tick: #00BFFF;
        }
        [data-theme="dark"] {
            --primary: #FFD700; 
            --accent: #002147; 
            --light: #121212;
            --white: #1e1e1e; 
            --text: #f4f4f4;
        }

        body { 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            background-color: var(--light); 
            color: var(--text); 
            margin: 0; 
            display: flex; 
            flex-direction: column;
            align-items: center; 
            padding: 15px; 
            transition: 0.3s; 
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container { 
            background: var(--white); 
            padding: 1.5rem; 
            border-radius: var(--radius); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); 
            width: 100%; 
            max-width: 600px; 
            text-align: center; 
            box-sizing: border-box;
        }
        
        .header { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            margin-bottom: 25px; 
            gap: 10px;
        }
        .back-btn, .share-btn { 
            padding: 10px 18px; 
            border-radius: 12px; 
            border: none; 
            cursor: pointer; 
            background: var(--primary); 
            color: var(--white); 
            font-weight: bold; 
            text-decoration: none; 
            font-size: 13px; 
            transition: 0.2s; 
            display: inline-flex;
            align-items: center;
        }
        .share-btn { 
            background: var(--online); 
            margin-top: 15px; 
            width: 100%; 
            justify-content: center;
            font-size: 14px;
            padding: 14px;
        }
        .back-btn:active, .share-btn:active { transform: scale(0.96); }

        .search-box { 
            width: 100%; 
            padding: 14px; 
            margin-bottom: 20px; 
            border-radius: 12px; 
            border: 1px solid rgba(0,0,0,0.1); 
            background: var(--light); 
            color: var(--text); 
            box-sizing: border-box; 
            outline: none; 
            font-size: 16px; 
            transition: border 0.3s;
        }
        .search-box:focus { border: 1px solid var(--primary); }

        .loader { width: 35px; height: 35px; border: 4px solid #ddd; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 25px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .leaderboard-list { text-align: left; min-height: 50px; }
        .entry { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px 15px; 
            margin-bottom: 10px; 
            background: rgba(128,128,128,0.04); 
            border-radius: 14px; 
            border: 1px solid rgba(0,0,0,0.03); 
            transition: 0.2s; 
        }
        /* Style for clickable verified profiles */
        .entry.verified-clickable { cursor: pointer; }
        .entry.verified-clickable:hover { background: rgba(0, 191, 255, 0.08); transform: translateX(5px); }

        .entry-info { display: flex; align-items: center; gap: 12px; }
        
        .level-tag { font-size: 9px; padding: 3px 8px; border-radius: 6px; text-transform: uppercase; font-weight: 800; margin-left: 5px; }
        .lvl-bronze { background: #cd7f32; color: white; }
        .lvl-silver { background: #c0c0c0; color: #333; }
        .lvl-gold { background: #ffd700; color: #002147; }
        .lvl-diamond { background: #b9f2ff; color: #005f73; box-shadow: 0 0 10px rgba(185, 242, 255, 0.5); }

        .online-dot { width: 10px; height: 10px; background: var(--online); border-radius: 50%; display: inline-block; margin-right: 8px; box-shadow: 0 0 10px var(--online); animation: pulse-online 2s infinite; }
        @keyframes pulse-online { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        .rank-emoji { font-size: 1.5rem; width: 35px; text-align: center; }
        .rank-number { font-weight: 800; color: var(--primary); width: 35px; text-align: center; display: inline-block; opacity: 0.5; }
        
        .name { font-weight: 600; font-size: 1rem; color: var(--text); }
        .streak { font-weight: 800; color: #ff5e00; font-size: 0.9rem; }
        .blue-tick { color: var(--blue-tick); font-size: 14px; margin-left: 4px; }

        @keyframes fireGlow {
            0% { box-shadow: 0 0 10px rgba(255, 69, 0, 0.2); border-color: #ff4500; }
            100% { box-shadow: 0 0 20px rgba(255, 140, 0, 0.4); border-color: #ffd700; }
        }
        .rank-1 { animation: fireGlow 1.5s infinite alternate; background: linear-gradient(90deg, rgba(255, 215, 0, 0.1), transparent) !important; border-width: 2px !important; }
        .rank-2 { border: 1.5px solid #C0C0C0 !important; }
        .rank-3 { border: 1.5px solid #CD7F32 !important; }

        .my-rank-card { 
            margin-top: 25px; 
            padding: 25px; 
            background: linear-gradient(135deg, var(--primary), #003366); 
            color: var(--white); 
            border-radius: 18px; 
            text-align: left; 
            position: relative; 
            overflow: hidden; 
            border-bottom: 6px solid var(--accent); 
            box-shadow: 0 15px 35px rgba(0,33,71,0.2);
        }
        .my-rank-card::after { content: 'BIU'; position: absolute; right: -15px; bottom: -15px; font-size: 70px; font-weight: 900; opacity: 0.08; transform: rotate(-10deg); }
        
        .trend-up { color: #00ff88; font-size: 11px; font-weight: bold; background: rgba(0,255,136,0.1); padding: 2px 8px; border-radius: 10px; }
        .trend-down { color: #ff4d4d; font-size: 11px; font-weight: bold; background: rgba(255,77,77,0.1); padding: 2px 8px; border-radius: 10px; }
        .sync-time { font-size: 10px; opacity: 0.5; margin-top: 12px; display: block; text-align: center; }

        .match-highlight { border: 2px solid var(--primary) !important; background: rgba(0, 33, 71, 0.05) !important; }

        @media (max-width: 480px) {
            body { padding: 10px; }
            .container { padding: 1rem; border-radius: 12px; }
            .rank-emoji, .rank-number { width: 25px; font-size: 1.2rem; }
            .entry { padding: 10px; }
            .name { font-size: 0.9rem; }
            .my-rank-card { padding: 20px; }
            .my-rank-card h2 { font-size: 1.4rem !important; }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <a href="index.html" class="back-btn">‚Üê Back</a>
            <h2 style="margin:0; font-size: 1.4rem;">Leaderboard</h2>
            <div style="width:40px;"></div>
        </div>

        <input type="text" id="searchBar" class="search-box" placeholder="Search scholars..." onkeyup="filterLeaderboard()">

        <div id="loading">
            <div class="loader"></div>
            <p style="font-size: 12px; opacity: 0.6;">Updating rankings...</p>
        </div>
        
        <div id="leaderboard-full" class="leaderboard-list"></div>
        <div id="personal-rank-container"></div>
        <div id="share-area"></div>

        <footer style="margin-top: 30px; font-size: 11px; opacity: 0.5; letter-spacing: 1px;">
            THE BIU ARCHIVE ¬© 2026
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBmZDLDyQ2YhMxsYal1q4d0hyr03VXEqak",
            authDomain: "biu-archive.firebaseapp.com",
            databaseURL: "https://biu-archive-default-rtdb.firebaseio.com",
            projectId: "biu-archive",
            storageBucket: "biu-archive.firebasestorage.app",
            messagingSenderId: "245967347998",
            appId: "1:245967347998:web:a8feb5ad0ef9650946a90f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const leaderboardDiv = document.getElementById('leaderboard-full');
        const personalDiv = document.getElementById('personal-rank-container');
        const loadingDiv = document.getElementById('loading');
        const shareArea = document.getElementById('share-area');

        if (localStorage.getItem('theme') === 'dark') document.body.setAttribute('data-theme', 'dark');

        function getLevelInfo(streak) {
            if (streak >= 30) return { title: "Diamond", class: "lvl-diamond" };
            if (streak >= 15) return { title: "Gold", class: "lvl-gold" };
            if (streak >= 7) return { title: "Silver", class: "lvl-silver" };
            if (streak >= 3) return { title: "Bronze", class: "lvl-bronze" };
            return { title: "Novice", class: "" };
        }

        onValue(ref(db, "users"), (snapshot) => {
            const data = snapshot.val();
            loadingDiv.style.display = 'none';
            
            if (!data) {
                leaderboardDiv.innerHTML = '<div style="text-align:center; opacity:0.5; padding: 20px;">No scholars found yet.</div>';
                return;
            }

            const allUsers = Object.entries(data).map(([id, val]) => ({ id, ...val }))
                .filter(u => u.name)
                .sort((a, b) => (b.streak || 0) - (a.streak || 0));

            renderList(allUsers);

            const currentUserId = localStorage.getItem('biu_user_id');
            const myIndex = allUsers.findIndex(u => u.id === currentUserId);

            if (myIndex !== -1) {
                const myData = allUsers[myIndex];
                const myCurrentRank = myIndex + 1;
                const lastRank = localStorage.getItem('biu_last_rank');
                const myTick = myData.isVerified ? '<span class="blue-tick">‚úì</span>' : '';
                
                let trendHTML = ``;
                if (lastRank) {
                    const diff = parseInt(lastRank) - myCurrentRank;
                    if (diff > 0) trendHTML = `<span class="trend-up">‚ñ≤ ${diff}</span>`;
                    else if (diff < 0) trendHTML = `<span class="trend-down">‚ñº ${Math.abs(diff)}</span>`;
                }
                localStorage.setItem('biu_last_rank', myCurrentRank);

                personalDiv.innerHTML = `
                    <div id="capture-card" class="my-rank-card">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <span style="font-size: 10px; letter-spacing:2px; opacity:0.8; font-weight:bold;">OFFICIAL RANK CARD</span>
                            ${trendHTML}
                        </div>
                        <div style="font-size: 22px; font-weight: 800; margin-bottom: 5px;">${myData.name}${myTick}</div>
                        <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-top:10px;">
                            <span style="font-size: 32px; font-weight: 900; color: var(--accent);">#${myCurrentRank}</span>
                            <span style="font-size: 16px; font-weight: 600;">üî• ${myData.streak || 0} Streak</span>
                        </div>
                    </div>
                    <span class="sync-time">Last Synced: ${new Date().toLocaleTimeString()}</span>
                `;
                shareArea.innerHTML = `<button class="share-btn" onclick="captureRank()">üì∏ Save Rank Image</button>`;
            }
        });

        function renderList(users) {
            const now = Date.now();
            leaderboardDiv.innerHTML = users.map((user, index) => {
                const level = getLevelInfo(user.streak || 0);
                const isOnline = (now - (user.lastActive || 0)) < 60000;
                const isVerified = !!user.isVerified;
                const userTick = isVerified ? '<span class="blue-tick">‚úì</span>' : '';
                
                let rankLabel = `<span class="rank-number">#${index + 1}</span>`;
                let rankClass = "";
                if (index === 0) { rankLabel = `<span class="rank-emoji">ü•á</span>`; rankClass = "rank-1"; }
                else if (index === 1) { rankLabel = `<span class="rank-emoji">ü•à</span>`; rankClass = "rank-2"; }
                else if (index === 2) { rankLabel = `<span class="rank-emoji">ü•â</span>`; rankClass = "rank-3"; }

                // Determine if this entry is a verified profile that can be viewed
                const clickAction = isVerified ? `onclick="window.location.href='view-profile.html?id=${user.id}'"` : '';
                const verifiedClass = isVerified ? 'verified-clickable' : '';

                return `
                    <div class="entry ${rankClass} ${verifiedClass}" data-name="${user.name.toLowerCase()}" ${clickAction}>
                        <div class="entry-info">
                            ${rankLabel}
                            <div>
                                <span class="name">${isOnline ? '<span class="online-dot"></span>' : ''}${user.name}${userTick}</span>
                                <span class="level-tag ${level.class}">${level.title}</span>
                            </div>
                        </div>
                        <span class="streak">üî• ${user.streak || 0}</span>
                    </div>
                `;
            }).join('');
        }

        window.filterLeaderboard = function() {
            const term = document.getElementById('searchBar').value.toLowerCase();
            document.querySelectorAll('.entry').forEach(item => {
                const name = item.getAttribute('data-name');
                if (name.includes(term)) {
                    item.style.display = 'flex';
                    item.classList.toggle('match-highlight', term !== "");
                } else {
                    item.style.display = 'none';
                }
            });
        };

        window.captureRank = function() {
            const btn = document.querySelector('.share-btn');
            const target = document.getElementById('capture-card');
            btn.innerText = "Generating...";
            html2canvas(target, { 
                backgroundColor: null, 
                scale: 3,
                borderRadius: 18
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'BIU-Archive-Achievement.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                btn.innerText = "üì∏ Save Rank Image";
            });
        };
    </script>
</body>
</html>